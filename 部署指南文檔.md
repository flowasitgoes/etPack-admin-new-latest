# 工廠ERP系統部署指南

## 專案概述

本專案為工廠ERP系統原型，採用Next.js 15 + React 19 + TypeScript技術棧開發。本指南提供在Vercel和Cloudflare Pages等雲端平台的完整部署步驟。

## 技術要求

### 系統環境
- **Node.js**: 18.0 或更高版本
- **包管理器**: pnpm (推薦) 或 npm/yarn
- **作業系統**: macOS, Linux, Windows

### 專案依賴
```json
{
  "next": "15.2.4",
  "react": "^19",
  "typescript": "^5",
  "tailwindcss": "^3.4.17"
}
```

---

## 方法一：Vercel 部署 (推薦)

### 1. 準備工作

#### 1.1 安裝 Vercel CLI
```bash
# 使用 npm 安裝
npm install -g vercel

# 或使用 pnpm 安裝
pnpm add -g vercel
```

#### 1.2 登入 Vercel 帳號
```bash
vercel login
```

#### 1.3 初始化專案配置
```bash
# 在專案根目錄執行
vercel
```

### 2. 專案配置檢查

確保 `vercel.json` 配置正確：
```json
{
  "buildCommand": "pnpm build",
  "installCommand": "pnpm install",
  "framework": "nextjs"
}
```

### 3. 環境變數配置

#### 3.1 本地開發環境變數
創建 `.env.local` 文件：
```bash
# 資料庫連接 (如果需要)
DATABASE_URL="your_database_url"

# API 金鑰 (如果需要)
API_KEY="your_api_key"

# JWT 密鑰
JWT_SECRET="your_jwt_secret"

# 其他環境變數...
```

#### 3.2 Vercel 環境變數設定
```bash
# 設定生產環境變數
vercel env add DATABASE_URL
vercel env add API_KEY
vercel env add JWT_SECRET
```

### 4. 部署步驟

#### 4.1 首次部署
```bash
# 部署到生產環境
vercel --prod
```

#### 4.2 自動部署設定
1. 連接 GitHub 倉庫
2. 推送到 main 分支自動觸發部署
3. 檢查部署狀態：`vercel ls`

#### 4.3 自訂域名設定
```bash
# 添加自訂域名
vercel domains add yourdomain.com

# 設定 DNS 解析
# 在域名服務商處添加 CNAME 記錄指向 Vercel
```

### 5. 部署故障排除

#### 5.1 建置失敗
```bash
# 檢查建置日誌
vercel logs --follow

# 本地測試建置
pnpm build
```

#### 5.2 環境變數問題
```bash
# 檢查環境變數
vercel env ls

# 重新設定環境變數
vercel env rm VARIABLE_NAME
vercel env add VARIABLE_NAME
```

#### 5.3 路由問題
確保 `next.config.mjs` 配置正確：
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    unoptimized: true,
  },
}

export default nextConfig
```

---

## 方法二：Cloudflare Pages 部署

### 1. 準備工作

#### 1.1 安裝 Cloudflare CLI
```bash
# 使用 npm 安裝
npm install -g wrangler

# 或使用 pnpm 安裝
pnpm add -g wrangler
```

#### 1.2 登入 Cloudflare 帳號
```bash
wrangler auth login
```

### 2. 專案配置

#### 2.1 創建 `wrangler.toml` 配置檔案
```toml
name = "erp-admin-system"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

[build]
command = "pnpm build"
cwd = "."

[build.upload]
format = "modules"
dir = ".next/static"
main = "../server.js"

[[build.upload.rules]]
type = "ESModule"
globs = ["**/*.js"]

# 環境變數
[vars]
NODE_ENV = "production"

# 如果需要設定環境變數
[vars]
DATABASE_URL = "your_database_url"
API_KEY = "your_api_key"
```

#### 2.2 修改 `package.json` 建置腳本
```json
{
  "scripts": {
    "build": "next build",
    "export": "next export",
    "deploy": "wrangler pages deploy .next/static"
  }
}
```

### 3. 適配 Cloudflare Pages

#### 3.1 修改 `next.config.mjs`
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  eslint: {
    ignoreDuringBuilds: true,
  },
  typescript: {
    ignoreBuildErrors: true,
  },
  images: {
    unoptimized: true,
    loader: 'custom',
    loaderFile: './image-loader.js'
  },
  // Cloudflare Pages 需要靜態導出
  trailingSlash: true,
  output: 'export',
  distDir: 'out',
}

export default nextConfig
```

#### 3.2 創建自訂圖片載入器
```javascript
// image-loader.js
export default function imageLoader({ src, width, quality }) {
  return `${src}?w=${width}&q=${quality || 75}`
}
```

### 4. 部署步驟

#### 4.1 建置專案
```bash
# 安裝依賴
pnpm install

# 建置專案
pnpm build

# 導出靜態文件
pnpm export
```

#### 4.2 部署到 Cloudflare Pages
```bash
# 首次部署
wrangler pages deploy out

# 或使用專案名稱部署
wrangler pages deploy out --project-name erp-admin-system
```

#### 4.3 設定自訂域名
```bash
# 在 Cloudflare 控制台設定
# 1. 進入 Pages > 你的專案
# 2. 設定 > 域名
# 3. 添加自訂域名
```

### 5. 環境變數設定

#### 5.1 在 Cloudflare 控制台設定
1. 進入 Cloudflare Pages 專案
2. 設定 > 環境變數
3. 添加以下變數：
   - `NODE_ENV`: `production`
   - `DATABASE_URL`: 你的資料庫連接字串
   - `API_KEY`: API 金鑰
   - `JWT_SECRET`: JWT 密鑰

#### 5.2 使用 wrangler 設定
```bash
# 設定環境變數
wrangler pages secrets put DATABASE_URL
wrangler pages secrets put API_KEY
wrangler pages secrets put JWT_SECRET
```

---

## 方法三：傳統 VPS/Server 部署

### 1. 伺服器準備

#### 1.1 系統要求
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nodejs npm

# 安裝 pnpm
npm install -g pnpm

# 安裝 PM2 進程管理器
npm install -g pm2
```

#### 1.2 專案部署
```bash
# 複製專案文件
git clone your-repo-url
cd erp-admin-v0-chris-latest

# 安裝依賴
pnpm install

# 建置專案
pnpm build

# 啟動服務
pm2 start npm --name "erp-admin" -- start

# 設定開機自啟動
pm2 startup
pm2 save
```

### 2. Nginx 配置

#### 2.1 安裝 Nginx
```bash
sudo apt install nginx
```

#### 2.2 建立 Nginx 配置
```nginx
# /etc/nginx/sites-available/erp-admin
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

#### 2.3 啟用配置
```bash
# 啟用站點
sudo ln -s /etc/nginx/sites-available/erp-admin /etc/nginx/sites-enabled/

# 測試配置
sudo nginx -t

# 重新載入 Nginx
sudo systemctl reload nginx
```

### 3. SSL 憑證設定

#### 3.1 使用 Let's Encrypt
```bash
# 安裝 Certbot
sudo apt install certbot python3-certbot-nginx

# 獲取 SSL 憑證
sudo certbot --nginx -d your-domain.com

# 設定自動續期
sudo crontab -e
# 添加以下行：
# 0 12 * * * /usr/bin/certbot renew --quiet
```

---

## 方法四：Docker 容器部署

### 1. 創建 Dockerfile

```dockerfile
# Dockerfile
FROM node:18-alpine

# 設定工作目錄
WORKDIR /app

# 複製 package.json 和 pnpm-lock.yaml
COPY package.json pnpm-lock.yaml ./

# 安裝依賴
RUN npm install -g pnpm && pnpm install

# 複製源代碼
COPY . .

# 建置應用
RUN pnpm build

# 暴露端口
EXPOSE 3000

# 啟動應用
CMD ["pnpm", "start"]
```

### 2. 創建 docker-compose.yml

```yaml
version: '3.8'
services:
  erp-admin:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=your_database_url
    restart: unless-stopped
    volumes:
      - ./data:/app/data
```

### 3. 部署步驟

```bash
# 建置和啟動容器
docker-compose up -d --build

# 查看日誌
docker-compose logs -f

# 停止服務
docker-compose down
```

---

## 效能優化建議

### 1. 建置優化

#### 1.1 Next.js 優化配置
```javascript
// next.config.mjs
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 啟用 SWC 編譯器
  swcMinify: true,

  // 圖片優化
  images: {
    formats: ['image/webp', 'image/avif'],
  },

  // 壓縮
  compress: true,

  // 緩存優化
  experimental: {
    optimizeCss: true,
  },
}

export default nextConfig
```

#### 1.2 環境變數優化
```bash
# 生產環境變數
NODE_ENV=production
NEXT_TELEMETRY_DISABLED=1
```

### 2. CDN 設定

#### 2.1 Cloudflare CDN
1. 在 Cloudflare 控制台啟用 CDN
2. 設定快取規則
3. 啟用 Brotli 壓縮

#### 2.2 Vercel Edge Network
- Vercel 預設啟用全球 CDN
- 自動優化資源分發

### 3. 監控和維護

#### 3.1 效能監控
```bash
# 使用 PM2 監控
pm2 monit

# 查看資源使用
pm2 show erp-admin
```

#### 3.2 日誌管理
```bash
# 查看應用日誌
pm2 logs erp-admin

# 日誌輪轉
pm2 install pm2-logrotate
```

---

## 故障排除

### 常見問題

#### 1. 建置失敗
```bash
# 清除快取
rm -rf .next node_modules/.cache
pnpm install
pnpm build
```

#### 2. 記憶體不足
```bash
# 增加 Node.js 記憶體限制
export NODE_OPTIONS="--max-old-space-size=4096"
```

#### 3. 端口衝突
```bash
# 檢查端口使用
lsof -i :3000

# 更改端口
PORT=3001 pnpm start
```

#### 4. 環境變數問題
```bash
# 檢查環境變數載入
console.log(process.env.DATABASE_URL)
```

---

## 安全檢查清單

### 部署前檢查
- [ ] 移除開發依賴
- [ ] 設定生產環境變數
- [ ] 啟用 HTTPS
- [ ] 配置防火牆
- [ ] 設定定期備份
- [ ] 啟用監控和日誌

### 安全配置
```bash
# 設定檔案權限
chmod 600 .env.local

# 定期更新依賴
pnpm audit
pnpm update
```

---

## 總結

本專案支援多種部署方式，建議根據實際需求選擇：

- **快速部署**: Vercel (推薦新手)
- **高性能**: Cloudflare Pages
- **完全控制**: VPS + Docker
- **企業級**: Kubernetes 集群

每種部署方式都有其優缺點，請根據團隊規模、預算和技術要求選擇合適的方案。
